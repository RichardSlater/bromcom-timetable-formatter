# Testing Strategy

This document describes how we approach testing for the Bromcom Timetable Formatter project.

## Goals

- Keep **>80% coverage** across core parsing, processing, and rendering logic.
- Provide fast feedback through unit tests and linting.
- Guard end-to-end behavior with integration tests that parse sample PDFs and inspect generated output.

## Test Types

### Unit Tests

Unit tests live alongside the Rust modules under `crates/*/src`. They focus on:

- Parsing heuristics (e.g., `parser.rs` regex/classification helpers)
- SVG/map processors (`processor.rs`)
- Renderer layout helpers (`renderer.rs`)
- Configuration parsing and validation (`config.rs`)

Unit tests run quickly and should be kept deterministic; avoid reading real PDFs here.

### Integration Tests

Integration tests live under `crates/*/tests`. They exercise real workflows using fixtures.

Current integration coverage:

- `parser_synthetic.rs`: loads `test/fixtures/synthetic_timetable.pdf` and asserts that `parse_pdf` produces a `Week 1` timetable with expected metadata and lessons.

Future coverage should include:

- Renderer snapshot tests that compare generated SVGs against golden files.
- End-to-end CLI runs that generate timetable + map outputs.

### Fixtures

Test fixtures are stored under `test/fixtures/`.

- `synthetic_timetable.pdf`: Deterministic Bromcom-style PDF generated by `scripts/create_synthetic_pdf.py`. The content contains week header, student name, day headings, period markers, and a handful of lessons so parser heuristics can be exercised without proprietary data.

To regenerate the PDF:

```bash
python3 scripts/create_synthetic_pdf.py
```

## Running Tests

From the repository root:

```bash
# Run everything (unit + integration)
cargo test --workspace

# Run only core parser tests with integration fixture
cargo test -p timetable_core synthetic_pdf_parses_expected_week

# Check formatting, linting, and clippy via CI-equivalent script
cargo fmt -- --check
cargo clippy --all-targets --all-features -- -D warnings
```

CI runs `cargo fmt`, `cargo clippy`, and `cargo test --workspace` on every commit and pull request.

## Coverage

We do not yet enforce coverage in CI, but developers should run `cargo llvm-cov` (or similar) when making significant parser/renderer changes to ensure coverage stays >80%.

```
cargo llvm-cov --workspace --lcov --output-path lcov.info
```

Document coverage results in pull requests touching critical logic.

## Writing New Tests

1. Identify whether behaviors can be tested at the unit level. Prefer unit tests for deterministic helpers.
2. When real PDFs or SVGs are required, add fixtures under `test/fixtures/` and write integration tests under `crates/<crate>/tests`.
3. Use helper scripts (like `scripts/create_synthetic_pdf.py`) to keep fixtures reproducible and free of proprietary data.
4. Update this document and `docs/TODO.md` when adding significant new test coverage areas.
